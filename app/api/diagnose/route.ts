import { NextResponse } from "next/server";

export async function POST(req: Request) {
  try {
    const { image, lineColor } = await req.json();

    if (!image) {
      return NextResponse.json({ error: "æ²¡æ”¶åˆ°å›¾ç‰‡" }, { status: 400 });
    }

    const apiKey = process.env.DASHSCOPE_API_KEY;
    if (!apiKey) {
      return NextResponse.json({ error: "æœåŠ¡å™¨æ²¡é…ç½®é˜¿é‡Œäº‘ Key" }, { status: 500 });
    }

    // æ„é€ é¢œè‰²é”å®šæŒ‡ä»¤
    let colorInstruction = "è¯·å¯»æ‰¾ã€åœ¨çº¿äººæ•°ã€‘æ›²çº¿ã€‚";
    if (lineColor && lineColor !== "è‡ªåŠ¨è¯†åˆ«") {
      colorInstruction = `
      **âš ï¸ è§†è§‰é”å®šæŒ‡ä»¤ï¼š**
      ä½ å¿…é¡»åªç›¯ç€ **${lineColor}** çš„é‚£æ¡çº¿çœ‹ï¼
      å›¾é‡Œå…¶ä»–é¢œè‰²çš„çº¿ï¼ˆç‰¹åˆ«æ˜¯æŸ±çŠ¶å›¾æˆ–é”¯é½¿çº¿ï¼‰å…¨æ˜¯å¹²æ‰°é¡¹ï¼Œ**ç›´æ¥å½“å®ƒä»¬ä¸å­˜åœ¨**ã€‚
      `;
    }

    const response = await fetch("https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: "qwen-vl-max", 
        messages: [
          {
            role: "system",
            content: "ä½ æ˜¯ä¸€ä¸ªåªç›¸ä¿¡ç‰©ç†åæ ‡çš„å‡ ä½•åˆ†ææœºå™¨äººã€‚ä½ æ²¡æœ‰ä»»ä½•é¢„è®¾åè§ï¼Œåªæ ¹æ®çº¿æ¡åœ¨ç”»é¢ä¸­çš„ã€ç‰©ç†é«˜åº¦ã€‘è¿›è¡Œåˆ¤æ–­ã€‚"
          },
          {
            role: "user",
            content: [
              { 
                type: "text", 
                text: `è¯·åˆ†æè¿™å¼ å›¾ä¸­çš„æ›²çº¿èµ°åŠ¿ã€‚

                ${colorInstruction}

                **ğŸ›‘ å¿…é¡»ä¸¥æ ¼æ‰§è¡Œã€ä¸‰ç‚¹ç‰©ç†å®šä½æ³•ã€‘ï¼ˆä¸è¦çŒœï¼Œå»æµ‹é‡ï¼‰ï¼š**

                **æ­¥éª¤ 1ï¼šç‰©ç†é«˜åº¦æµ‹é‡**
                è¯·æŠŠå›¾è¡¨çš„é«˜åº¦çœ‹ä½œ 0% (åº•éƒ¨) åˆ° 100% (é¡¶éƒ¨)ã€‚
                1. **èµ·ç‚¹é«˜åº¦ (A)**ï¼šæ›²çº¿æœ€å·¦ç«¯çš„ç‚¹ï¼Œå¤§çº¦åœ¨é«˜åº¦çš„ç™¾åˆ†ä¹‹å¤šå°‘ï¼Ÿ(ä¾‹å¦‚ï¼š10% / 90%)
                2. **ä¸­é—´é«˜åº¦ (B)**ï¼šæ›²çº¿ä¸­é—´éƒ¨åˆ†çš„å¹³å‡é«˜åº¦ï¼Œå¤§çº¦æ˜¯å¤šå°‘ï¼Ÿ
                3. **ç»ˆç‚¹é«˜åº¦ (C)**ï¼šæ›²çº¿æœ€å³ç«¯çš„ç‚¹ï¼Œå¤§çº¦åœ¨é«˜åº¦çš„ç™¾åˆ†ä¹‹å¤šå°‘ï¼Ÿ

                **æ­¥éª¤ 2ï¼šæ•°å­¦é€»è¾‘åˆ¤å®š (ä¸¥ç¦è¿èƒŒ)**
                - å¦‚æœ **C (ç»ˆç‚¹) æ˜æ˜¾é«˜äº A (èµ·ç‚¹)**ï¼š
                  -> ç»“è®ºå¿…é¡»æ˜¯ **ã€Jå‹ / çˆ¬å¡å‹ã€‘** (å“ªæ€•ä¸­é—´æœ‰æ³¢åŠ¨)ã€‚
                - å¦‚æœ **A (èµ·ç‚¹) æ˜æ˜¾é«˜äº C (ç»ˆç‚¹)**ï¼š
                  -> ç»“è®ºå¿…é¡»æ˜¯ **ã€Lå‹ / é«˜å¼€ä½èµ°ã€‘**ã€‚
                - å¦‚æœ **A å’Œ C éƒ½åœ¨ä½ä½ (ä¾‹å¦‚éƒ½å°äº20%)** ä¸” B ä¹Ÿå¾ˆä½ï¼š
                  -> ç»“è®ºå¿…é¡»æ˜¯ **ã€ç»‡å¸ƒæœº / åƒµå°¸å·ã€‘**ã€‚
                - å¦‚æœ **æ›²çº¿å¤§èµ·å¤§è½ (æ³¢å³°æ³¢è°·å·®è·å·¨å¤§)**ï¼š
                  -> ç»“è®ºæ˜¯ **ã€Må‹ / è¿‡å±±è½¦ã€‘**ã€‚

                **æ­¥éª¤ 3ï¼šå›¾å½¢åŒ¹é… (è§†è§‰æ ¡å‡†)**
                è¿™æ¡çº¿æœ€åƒä¸‹é¢å“ªä¸ª ASCII ç¬¦å·ï¼Ÿ
                A. ğŸ“ˆ (ä¸€ç›´æ¶¨)
                B. ğŸ“‰ (ä¸€ç›´è·Œ)
                C. ã€°ï¸ (éœ‡è¡)
                D. â– (å¹³èºº)

                **ğŸ“ è¾“å‡ºç»™å®¢æˆ·çš„è¯Šæ–­æŠ¥å‘Š (Markdownæ ¼å¼ï¼Œåªè¾“å‡ºç»“è®ºï¼Œéšè—æ€è€ƒ)ï¼š**

                # ğŸ“Š ç›´æ’­é—´æ•°æ®è¯Šæ–­ä¹¦

                ## 1. æ ¸å¿ƒç»“è®º
                - **å½“å‰çŠ¶æ€**ï¼š[Jå‹çˆ¬å¡ / Lå‹ä¸‹æ»‘ / åƒµå°¸å·]
                - **ç¡¬æ ¸è¯æ®**ï¼š[åŸºäºä¸Šé¢çš„é«˜åº¦å¯¹æ¯”ã€‚ä¾‹å¦‚ï¼šå¼€æ’­æ—¶å¤„äºä½ä½ï¼Œå½“å‰å¤„äºé«˜ä½ï¼Œå®ç°äº†é€†åŠ¿å¢é•¿ã€‚]

                ## 2. æµé‡èµ°åŠ¿è§£è¯»
                - **èµ°åŠ¿åˆ¤å®š**ï¼š[ç›´æ¥è¯´ç»“æœ]
                - **è¿è¥é—®é¢˜åˆ†æ**ï¼š
                   > [å¦‚æœæ˜¯ Jå‹ï¼šæ­å–œï¼Œè¯´æ˜è¯æœ¯ç•™äººèƒ½åŠ›æå¼ºï¼Œç³»ç»Ÿæ­£åœ¨æ¨æµã€‚]
                   > [å¦‚æœæ˜¯ Lå‹ï¼šè­¦å‘Šï¼Œå¼€åœºè¯æœ¯æ²¡æœ‰é’©å­ï¼Œç¬¬ä¸€æ³¢æµé‡å…¨æ¼äº†ã€‚]
                   > [å¦‚æœæ˜¯ åƒµå°¸å·ï¼šè´¦å·æ ‡ç­¾å¯èƒ½è·‘åäº†ã€‚]

                ## 3. ğŸš‘ ä¼˜åŒ–å»ºè®®
                1. **[åŠ¨ä½œä¸€]**
                2. **[åŠ¨ä½œäºŒ]**
                3. **[åŠ¨ä½œä¸‰]**
                ` 
              },
              { 
                type: "image_url", 
                image_url: { url: image } 
              }
            ]
          }
        ],
        max_tokens: 2000
      }),
    });

    const data = await response.json();

    if (!response.ok) {
      return NextResponse.json({ error: `AIåˆ†æå¤±è´¥: ${data.error?.message}` }, { status: 500 });
    }

    const aiText = data.choices[0].message.content;
    return NextResponse.json({ result: aiText });

  } catch (error) {
    return NextResponse.json({ error: "æœåŠ¡å™¨å¤„ç†å‡ºé”™" }, { status: 500 });
  }
}